

要让 **WSL2** 能连到你 Windows 上的代理，“**Allow LAN（允许局域网连接）**”就是把代理的本地监听从 `127.0.0.1` 放开到 `0.0.0.0`（所有网卡），这样 WSL2 通过虚拟网卡（`vEthernet (WSL)`，如 `172.x.x.x` 网段）就能访问你的代理端口。

下面按常见工具给出开启方法 + 验证步骤（任选你正在用的）：

---

## 一、Clash for Windows（CFW）

1. 打开 CFW → 左侧 **General**（通用）页。
2. 打开 **Allow LAN** 开关。
3. 记下端口：

   * `Mixed Port`（常用一个口，例如 7890）
   * 或分别的 `HTTP Port` / `SOCKS Port`（如 7890 / 7891）
4. 若你用的是 YAML 配置，可在配置里确认：

   ```yaml
   mixed-port: 7890        # 或 http-port: 7890 / socks-port: 7891
   allow-lan: true
   bind-address: 0.0.0.0   # 新版可不写，打开 Allow LAN 会自动对外
   ```
5. 回到主界面点 **Apply/保存** 使其生效。

> **Clash Verge / Verge Rev** 类似：进入 **Settings/General** → 打开 **Allow LAN** 或 **LAN Sharing**，并确认 `Mixed/HTTP/SOCKS` 端口。

---

## 二、v2rayN（Windows）

1. 菜单 **参数设置**（或“设置”）→ **常规设置 / 监听设置**。
2. 勾选 **“允许来自局域网的连接”**。
3. 确认 **本地 SOCKS 端口**、**HTTP 端口**（例如 10808 / 10809，或你自定义）。
4. 保存并重启 v2rayN。

---

## 三、sing-box（GUI 或手工 JSON）

* GUI：在 **Inbound/入站** 里，把 **listen** 设成 **0.0.0.0**（而不是 127.0.0.1）。
* JSON 示例：

  ```json
  {
    "inbounds": [
      { "type": "http",  "listen": "0.0.0.0", "listen_port": 7890 },
      { "type": "socks", "listen": "0.0.0.0", "listen_port": 7891, "sniff": { "enabled": true } }
    ]
  }
  ```

---

## 四、开启后在 Windows 侧自检

在 **PowerShell** 查看端口是否对外监听：

```powershell
netstat -ano | findstr ":7890"
# 期望看到 0.0.0.0:7890 或 0.0.0.0:7891（SOCKS），或 0.0.0.0:混合端口
```

若只有 `127.0.0.1:7890`，说明还没放开（Allow LAN 没成功或被策略拦截）。

**（可选）放行防火墙端口并限制作用域到本地子网：**

```powershell
# 允许本机 7890 端口入站，仅限本地子网
New-NetFirewallRule -DisplayName "Proxy7890 LAN" `
  -Direction Inbound -LocalPort 7890 -Protocol TCP -Action Allow `
  -RemoteAddress LocalSubnet
```

---

## 五、在 WSL2 里验证

先确认你的 **WSL 网关**（Windows 在 WSL 网段的 IP，例如你之前的是 `172.19.128.1`）：

```bash
ip route | awk '/default/ {print $3}'
# 输出类似 172.19.128.1
```

### 方式 A：如果 WSL2 支持 localhost 映射（多数 Win11 可用）

```bash
curl -I --proxy http://127.0.0.1:7890 https://httpbin.org/ip
# 如有 SOCKS 端口，DNS 也走代理：
curl -I --socks5-hostname 127.0.0.1:7891 https://httpbin.org/ip
```

### 方式 B：用网关 IP（通用，需 Allow LAN 已开启）

```bash
curl -I --proxy http://172.19.128.1:7890 https://httpbin.org/ip
curl -I --socks5-hostname 172.19.128.1:7891 https://httpbin.org/ip
```

能返回 `HTTP/2 200` 或显示你的出口 IP，就表示 **WSL→Windows 代理** OK。

然后再设置环境变量（任选你测通的地址）：

```bash
# 如果 localhost 可用：
export http_proxy="http://127.0.0.1:7890"
export https_proxy="http://127.0.0.1:7890"
# 推荐 SOCKS（socks5h 让 DNS 也走代理）
export all_proxy="socks5h://127.0.0.1:7891"
export no_proxy="localhost,127.0.0.1,::1,.local,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"

# 如果用网关 IP：
# export http_proxy="http://172.19.128.1:7890"
# export https_proxy="http://172.19.128.1:7890"
# export all_proxy="socks5h://172.19.128.1:7891"
```

---

## 六、常见问题

* **连接仍被拒绝**：

  * 工具未真正对外监听（Allow LAN 没开成功）；
  * Windows 防火墙或安全软件拦截；
  * 端口号记错（CFW Mixed/HTTP/SOCKS 各不相同）。
* **WSL 里能连 127.0.0.1，但 IP 不通**：可能没开 Allow LAN，或防火墙未放行到 `vEthernet (WSL)`。
* **DNS 解析失败**：

  * 给应用加 `all_proxy=socks5h://...`，让 DNS 也走代理；
  * 或把 `/etc/resolv.conf` 指向能递归解析的 **内网 DNS**（而不是网关）。

---

需要我根据你具体的客户端（比如 CFW/Verge/v2rayN/sing-box）给一张**一键核对清单**吗？发我工具名称和你看到的端口号就行，我给你定制化检查点。


```
bill@leiyu-pc:~$ curl -I --proxy http://127.0.0.1:7890 https://httpbin.org/ip
curl: (7) Failed to connect to 127.0.0.1 port 7890: Connection refused
bill@leiyu-pc:~$ curl -I --socks5-hostname 127.0.0.1:7891 https://httpbin.org/ip
curl: (7) Failed to connect to 127.0.0.1 port 7891: Connection refused
bill@leiyu-pc:~$ curl -I --proxy http://172.19.128.1:7890 https://httpbin.org/ip
HTTP/1.1 200 Connection established

HTTP/2 200
date: Tue, 26 Aug 2025 10:37:37 GMT
content-type: application/json
content-length: 30
server: gunicorn/19.9.0
access-control-allow-origin: *
access-control-allow-credentials: true

bill@leiyu-pc:~$ curl -I --socks5-hostname 172.19.128.1:7891 https://httpbin.org/ip
^C
bill@leiyu-pc:~$
```


****************************************************************************************************************************

很好！现在形势非常清楚了：

* `curl --proxy http://172.19.128.1:7890 https://httpbin.org/ip` ✅ 成功
* `127.0.0.1:7890/7891` ❌ 在 WSL 内不可用（WSL 的 localhost 没映射到 Windows；或你的代理只监听在 Win 的本机而未做 localhost 转发）
* `172.19.128.1:7891`（SOCKS）⌛ 没响应，多半**没开 SOCKS 端口**（Clash 一般只开了 Mixed/HTTP 7890；或 SOCKS 端口被关）

结论：**HTTP 代理用 `172.19.128.1:7890` 没问题**，直接用这个做全局代理即可；SOCKS 先不强求（除非你确实需要 DNS 也走代理，再去 Windows 端开启 SOCKS5 端口）。

---

## 一步到位：在 WSL 设置环境变量（用你测通的地址）

把下面几行先直接执行，确认各种工具可用：

```bash
# 用 HTTP 代理（你测通的 172.19.128.1:7890）
export http_proxy="http://172.19.128.1:7890"
export https_proxy="http://172.19.128.1:7890"

# 有些程序也认 ALL_PROXY（即使是 http 方案也行）
export ALL_PROXY="http://172.19.128.1:7890"

# 内网不走代理
export no_proxy="localhost,127.0.0.1,::1,.local,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
```

> 说明：用 HTTP CONNECT 模式访问 HTTPS 站点时，**目标域名解析由代理端完成**，所以你本机（WSL）的 DNS 就算不稳定，依然能访问外网资源（你刚才那条 `curl` 已经证明了）。

### 可选：如果你**确实需要** DNS 也走代理

在 Windows 端把 SOCKS5 端口（如 7891）打开（Clash 开 Allow LAN 后，再在设置里启用 `socks-port`），然后在 WSL 改为：

```bash
export all_proxy="socks5h://172.19.128.1:7891"  # socks5h 会把 DNS 也交给代理解析
```

---

## 让包管理器/工具也走代理

### APT（Debian/Ubuntu）

```bash
sudo tee /etc/apt/apt.conf.d/80proxy >/dev/null <<EOF
Acquire::http::Proxy  "http://172.19.128.1:7890/";
Acquire::https::Proxy "http://172.19.128.1:7890/";
EOF

sudo apt update
```

### Git

```bash
git config --global http.proxy  "http://172.19.128.1:7890"
git config --global https.proxy "http://172.19.128.1:7890"
```

### npm / pip（按需）

```bash
# npm
npm config set proxy "http://172.19.128.1:7890"
npm config set https-proxy "http://172.19.128.1:7890"

# pip（用户级）
mkdir -p ~/.pip
cat > ~/.pip/pip.conf <<EOF
[global]
proxy = http://172.19.128.1:7890
EOF
```

---

## 持久化（登录即生效）

把“自动获取网关 + 设置代理”的几行放进 `~/.bashrc`（或 `~/.zshrc`）：

```bash
cat <<'EOF' >> ~/.bashrc
# auto-proxy via Windows gateway for WSL2
GW=$(ip route | awk '/default/ {print $3; exit}')
export http_proxy="http://$GW:7890"
export https_proxy="http://$GW:7890"
export ALL_PROXY="http://$GW:7890"
export no_proxy="localhost,127.0.0.1,::1,.local,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
EOF

source ~/.bashrc
```

> 以后网关 IP 变了也不用手改。

---

## 快速自检

```bash
# 走代理访问
curl -I https://www.baidu.com
curl -I https://httpbin.org/ip

# APT
sudo apt update
```

---

## 如果你想要 SOCKS（让 DNS 也走代理）

在 Windows 端（以 Clash for Windows 为例）：

* General（通用）→ 打开 **Allow LAN**
* 配置里确认：

  ```yaml
  mixed-port: 7890   # 已经通了
  socks-port: 7891   # 补上这一行并启用
  allow-lan: true
  ```
* 应用/重启后，在 WSL：

  ```bash
  export all_proxy="socks5h://172.19.128.1:7891"
  curl -I --socks5-hostname 172.19.128.1:7891 https://httpbin.org/ip
  ```

---

### 小结

* 你这台机：**用 `172.19.128.1:7890` 作为 HTTP 代理即可畅通**。
* `127.0.0.1:*` 在 WSL 内连接被拒绝属正常（没有 localhost 映射或程序没监听）。
* SOCKS 端口目前没开，所以挂起；只有在需要 DNS 也走代理时再开，不是必需。

如果还想要一个“一键启停代理”的脚本（开/关环境变量、apt 配置），告诉我你常用的软件清单，我直接给你定制版。

