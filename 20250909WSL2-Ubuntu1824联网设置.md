ç»“è®ºå…ˆè¯´ï¼š**è¿™å¥— `~/.bashrc` æ€è·¯åœ¨ WSL2 çš„ Ubuntu 24.04 é‡ŒåŒæ ·å¯è¡Œ**ï¼ˆæŒ‰é»˜è®¤ NAT ç½‘ç»œï¼‰ã€‚ä¸è¿‡ä½ è¿™ä»½é…ç½®é‡Œæœ‰å‡ ç‚¹å¯ä¼˜åŒ–/è¸©å‘éœ€è¦ä¿®æ­£ï¼Œç»™ä½ ä¸€ä»½â€œç¨³å¥ç‰ˆæ¨¡æ¿â€å’ŒéªŒè¯&æ’é”™æ¸…å•ã€‚

---

## 20251127 ç¨³å®šç‰ˆ

å¥½ï¼Œä¿¡æ¯ç°åœ¨å¾ˆæ¸…æ¥šäº†ï¼š

* Windows ä¸Š 7890 ç«¯å£ **ç¡®å®åœ¨ç›‘å¬**ï¼ˆ`0.0.0.0:7890 LISTENING` âœ…ï¼‰
* ä½†ä» WSL è¿ `192.168.110.206:7890` å¾—åˆ° `Connection refused` âŒ

è¿™è¯´æ˜ï¼š**é—®é¢˜ä¸æ˜¯ Clash/ç«¯å£æ²¡å¼€ï¼Œè€Œæ˜¯æˆ‘ä»¬è¿é”™äº†åœ°å€ / Windows ä¸æ¥å—ä»è¿™ä¸ªè·¯å¾„æ¥çš„è¿æ¥**ã€‚

å…¶å®åœ¨ä½ ç°åœ¨çš„ Windows / WSL2 ç‰ˆæœ¬é‡Œï¼Œæœ‰ä¸€ä¸ªæ›´ç®€å•ã€æœ€ç¨³çš„ç”¨æ³•ï¼š

> åœ¨ WSL2 é‡Œè®¿é—® Windows çš„ `127.0.0.1:7890` å°±å¯ä»¥äº†ï¼Œä¸è¦å»æŠ˜è…¾ 192.168.x.xã€10.x.x.x è¿™äº› IPã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š
**WSL2 â†’ `http://127.0.0.1:7890` â†’ Windows çš„æœ¬æœº 7890 ç«¯å£** æ˜¯å®˜æ–¹æ”¯æŒçš„â€œlocalhost è½¬å‘â€ï¼Œä¸éœ€è¦ Allow LANã€ä¸éœ€è¦çŸ¥é“ DHCP åˆ†çš„ä»€ä¹ˆ IPã€‚

---

## å…ˆåšä¸€ä¸ªæœ€ç›´æ¥çš„æµ‹è¯•ï¼ˆä¸æ”¹è„šæœ¬ï¼‰

åœ¨ WSL é‡Œæ‰§è¡Œï¼š

```bash
proxy_off

export http_proxy="http://127.0.0.1:7890"
export https_proxy="$http_proxy"

echo "$http_proxy"
curl -I https://www.google.com
```

å¦‚æœè¿™æ—¶å€™ä¸å†æ˜¯ `Connection refused`ï¼Œè€Œæ˜¯è¿”å› HTTP 200/301 ä¹‹ç±»ï¼Œå°±è¯æ˜ï¼š

* WSL2 â†’ 127.0.0.1:7890 â†’ Windows Clash è¿™æ¡è·¯æ˜¯é€šçš„ âœ…
* é—®é¢˜åªæ˜¯æˆ‘ä»¬ä¹‹å‰è„šæœ¬æŠŠåœ°å€ææˆ 192.168.110.x / 10.255.x.x è¿™äº›å¤–ç½‘ IP äº† âŒ

ä½ å¯ä»¥å…ˆè·‘ä¸€è·‘ï¼Œ**æˆ‘ä¸‹é¢ç›´æ¥ç»™è„šæœ¬æ”¹æ³•ï¼Œå‡è®¾ 127.0.0.1 æ˜¯å¯ç”¨çš„**ã€‚

---

## æŠŠ `.bashrc` æ”¹æˆâ€œæ°¸è¿œç”¨ 127.0.0.1:7890â€

æ—¢ç„¶ Windows é‚£è¾¹å·²ç»æœ‰ï¼š

```text
TCP    0.0.0.0:7890  LISTENING
TCP    127.0.0.1:7890 LISTENING
```

é‚£æˆ‘ä»¬åœ¨ WSL é‡Œå°±æ²¡å¿…è¦å†åŠ¨æ€ç®— IP äº†ï¼Œç›´æ¥æ°¸è¿œèµ° 127.0.0.1 å°±è¡Œï¼Œç®€å•ã€ç¨³å®šã€ä¸æ€• DHCPã€‚

### 1. ç¼–è¾‘ `~/.bashrc`

åœ¨ WSL é‡Œï¼ˆbill ç”¨æˆ·ï¼‰ï¼š

```bash
vim ~/.bashrc
# æˆ– nano ~/.bashrc
```

æ‰¾åˆ°ä½ åˆšæ‰åŠ çš„æ•´æ®µ `WSL2 auto-proxy`ï¼ˆåŒ…å« `wsl_host_ip()`ã€`proxy_on`ã€`proxy_off` è¿™ä¸€å¤§æ®µï¼‰ï¼Œ**æ•´å—åˆ æ‰**ã€‚

ç„¶åç”¨ä¸‹é¢è¿™æ®µ**æ›¿æ¢è¿›å»**ï¼ˆå®Œæ•´å¤åˆ¶ï¼‰ï¼š

```bash
# ---------- WSL2 auto-proxy (use Windows localhost) ----------
# HTTP proxy port used by Clash (change if needed)
WSL_PROXY_PORT=7890

# For modern WSL2 on Windows 10/11, accessing 127.0.0.1:PORT from WSL
# will be forwarded to Windows host 127.0.0.1:PORT.
WSL_PROXY_HOST="127.0.0.1"

proxy_on() {
  local host="$WSL_PROXY_HOST"

  export http_proxy="http://${host}:${WSL_PROXY_PORT}"
  export https_proxy="$http_proxy"
  export ftp_proxy="$http_proxy"
  export all_proxy="$http_proxy"
  export HTTP_PROXY="$http_proxy"
  export HTTPS_PROXY="$http_proxy"
  export FTP_PROXY="$http_proxy"
  export ALL_PROXY="$http_proxy"

  export no_proxy="localhost,127.0.0.1,::1,.local,.wsl,host.docker.internal,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
  export NO_PROXY="$no_proxy"

  echo "[proxy_on] proxy set to ${host}:${WSL_PROXY_PORT}"
}

proxy_off() {
  unset http_proxy https_proxy ftp_proxy all_proxy HTTP_PROXY HTTPS_PROXY FTP_PROXY ALL_PROXY
  unset no_proxy NO_PROXY
  echo "[proxy_off] proxy env cleared."
}

# Auto-enable proxy on shell start (comment this line if you don't want that)
proxy_on
```

ä¿å­˜é€€å‡ºã€‚

### 2. é‡æ–°åŠ è½½å¹¶éªŒè¯

```bash
source ~/.bashrc

echo "$http_proxy"
curl -I https://www.google.com
curl -I http://www.baidu.com
```

æœŸæœ›çœ‹åˆ°ï¼š

* `http_proxy` æ˜¾ç¤ºï¼š`http://127.0.0.1:7890`
* `curl` ä¸å†æ˜¯ `Connection refused`ï¼Œè€Œæ˜¯æœ‰ HTTP å“åº”å¤´ï¼ˆæ¯”å¦‚ 200 / 301ï¼‰ã€‚

---

## å¦‚æœ 127.0.0.1 è¿˜æ˜¯è¢«æ‹’ç»æ€ä¹ˆåŠï¼Ÿ

è¿™ç§æƒ…å†µå°±æ¯”è¾ƒå°‘ï¼Œä½†å¦‚æœå‡ºç°äº†ï¼Œå¯ä»¥å†è¡¥ä¸¤æ­¥æ’æŸ¥ï¼š

1. åœ¨ **WSL é‡Œ ping ä¸€ä¸‹ 127.0.0.1:7890**ï¼ˆç”¨ `nc` / `telnet`ï¼‰ï¼š

   ```bash
   nc -vz 127.0.0.1 7890
   # æˆ–
   telnet 127.0.0.1 7890
   ```

   * å¦‚æœèƒ½å»ºç«‹è¿æ¥ï¼Œè¯´æ˜ WSL åˆ° Windows çš„ localhost è½¬å‘æ²¡é—®é¢˜ï¼›
   * å¦‚æœä¾æ—§ `Connection refused`ï¼Œé‚£å¯èƒ½æ˜¯å½“å‰ Windows ç‰ˆæœ¬ / è®¾ç½®æ²¡æœ‰å¯ç”¨è¿™ç§è½¬å‘ï¼Œæˆ‘ä»¬å†é€€å›â€œåŠ¨æ€æ‰¾ä¸»æœº IP çš„æ–¹æ¡ˆâ€ï¼Œä½†ä¼šå†ç»“åˆè·¯ç”±å’Œé˜²ç«å¢™ç»†è°ƒã€‚

2. å†å¯¹ç…§ä¸€æ¬¡ Windows ä¸Šçš„é˜²ç«å¢™ / å®‰å…¨è½¯ä»¶è®¾ç½®ï¼Œç¡®è®¤æ²¡æœ‰æŠŠæ¥è‡ª WSL å­ç½‘çš„è¿æ¥æ‹¦æˆªæ‰ã€‚

---

## æ€»ç»“ä¸€å¥è¯

* ä» `netstat` æ¥çœ‹ï¼Œ**Clash å·²ç»æ­£å¸¸ç›‘å¬ 0.0.0.0:7890**ï¼›
* é—®é¢˜å‡ºåœ¨ **WSL è¿æ¥åˆ°äº†ä¸€ä¸ªé”™è¯¯çš„ IPï¼ˆ10.255... æˆ– 192.168...ï¼‰** ä¸Šï¼›
* å¯¹ä½ è¿™ç§å¼€å‘ç¯å¢ƒï¼Œ**æœ€ç®€å•ä¹Ÿæ˜¯æœ€ç¨³çš„åŠæ³•å°±æ˜¯ï¼šWSL ç›´æ¥ç”¨ `127.0.0.1:7890` è®¿é—® Windows**ï¼Œä¸å†ç®¡ DHCP å˜åŒ–ï¼›
* æŠŠ `.bashrc` æ”¹æˆæ°¸è¿œç”¨ `127.0.0.1`ï¼ŒåŸºæœ¬å°±ä¸€åŠ³æ°¸é€¸äº†ã€‚



ä¸‹é¢ç»™ä½ ä¸€å¥—**åœ¨ WSL(Ubuntu ä¸ºä¾‹) å®‰è£… nvm çš„å®Œæ•´æ­¥éª¤**ï¼Œç…§ç€æ•²å°±è¡Œï¼Œä¹Ÿé¡ºä¾¿å¸®ä½ è§£å†³ä¹‹å‰ `nvm: command not found` çš„é—®é¢˜ã€‚

---

## ä¸€ã€ç¡®è®¤ç¯å¢ƒ

åœ¨ WSL é‡Œæ‰§è¡Œï¼š

```bash
cat /etc/os-release
```

çœ‹åˆ°ç±»ä¼¼ï¼š

```text
ID=ubuntu
VERSION_ID="20.04"
```

åªè¦æ˜¯ Ubuntu/Debian ç³»çš„ï¼Œä¸‹é¢æ­¥éª¤éƒ½é€šç”¨ã€‚

---

## äºŒã€å®‰è£…åŸºç¡€å·¥å…·

```bash
sudo apt update
sudo apt install -y curl ca-certificates git
```

> è¯´æ˜ï¼šnvm å®˜æ–¹å®‰è£…è„šæœ¬æ˜¯é€šè¿‡ `curl` æ‹‰å–çš„ï¼Œæ‰€ä»¥å¿…é¡»å…ˆè£… curlã€‚

---

## ä¸‰ã€è¿è¡Œ nvm å®‰è£…è„šæœ¬

> âš ï¸ æ³¨æ„ï¼š**ç”¨æ™®é€šç”¨æˆ·æ‰§è¡Œï¼Œä¸è¦ç”¨ sudo**ã€‚
> æ¯”å¦‚ä½ çš„ WSL æç¤ºæ˜¯ `bill@WIN-xxxx:~$`ï¼Œå°±ç”¨è¿™ä¸ªç”¨æˆ·è£…ã€‚

æ‰§è¡Œï¼ˆç¤ºä¾‹ç”¨ v0.39.7 ç‰ˆæœ¬ï¼Œä½ ä»¥åå¯ä»¥æŠŠç‰ˆæœ¬å·æ¢æˆæœ€æ–°çš„ï¼‰ï¼š

```bash
curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
```

è¿è¡Œå®Œä¼šæœ‰ç±»ä¼¼æç¤ºï¼šå·²ç»åœ¨ `~/.bashrc` / `~/.profile` é‡ŒåŠ äº†å‡ è¡Œ `export NVM_DIR=...` çš„ä»£ç ã€‚

---

## å››ã€è®©å½“å‰ç»ˆç«¯ç”Ÿæ•ˆ

å®‰è£…è„šæœ¬åªæ”¹äº†é…ç½®æ–‡ä»¶ï¼Œè¦ä¹ˆé‡æ–°æ‰“å¼€ä¸€ä¸ª WSL ç»ˆç«¯ï¼Œè¦ä¹ˆæ‰‹åŠ¨ source ä¸€ä¸‹ï¼š

```bash
# å¦‚æœä½ ç”¨ bashï¼ˆWSL é»˜è®¤å°±æ˜¯ bashï¼‰
source ~/.bashrc
# æœ‰äº›æ—§ç¯å¢ƒç”¨çš„æ˜¯ ~/.profileï¼Œä¹Ÿå¯ä»¥é¡ºæ‰‹ source ä¸€ä¸‹
source ~/.profile 2>/dev/null || true
```

ç„¶åæµ‹è¯•ï¼š

```bash
nvm --version
```

å¦‚æœèƒ½è¾“å‡ºç‰ˆæœ¬å·ï¼Œæ¯”å¦‚ `0.39.7`ï¼Œè¯´æ˜å®‰è£…æˆåŠŸã€‚

> å¦‚æœè¿˜æ˜¯ `command not found`ï¼Œå¤šåŠæ˜¯ï¼š
>
> * ä½ ç”¨çš„æ˜¯ zsh / å…¶å®ƒ shellï¼Œæ²¡åŠ è½½ `~/.bashrc`
> * æˆ–è€…è¿œç¨‹æ‰§è¡Œè„šæœ¬æ—¶æ²¡è‡ªåŠ¨åŠ è½½é…ç½®
>   è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥æ‰‹åŠ¨åœ¨éœ€è¦ç”¨çš„è„šæœ¬å‰åŠ ä¸€è¡Œï¼š
>
> ```bash
> export NVM_DIR="$HOME/.nvm"
> [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
> ```

---

## äº”ã€ç”¨ nvm å®‰è£… Node.js

æœ‰äº† nvm ä¹‹åï¼Œä¸€èˆ¬è¿™æ ·ç”¨ï¼š

1. å®‰è£…ä¸€ä¸ª LTS ç‰ˆæœ¬ï¼š

   ```bash
   nvm install --lts
   ```

2. æŸ¥çœ‹å½“å‰å·²å®‰è£…çš„ Node ç‰ˆæœ¬ï¼š

   ```bash
   nvm ls
   ```

3. åœ¨ä¸åŒç‰ˆæœ¬ä¹‹é—´åˆ‡æ¢ï¼š

   ```bash
   nvm use v20.18.0   # ä¸¾ä¾‹ï¼Œç‰ˆæœ¬å·ä»¥ä½ è‡ªå·±å®‰è£…çš„ä¸ºå‡†
   ```

4. è®¾ç½®é»˜è®¤ç‰ˆæœ¬ï¼ˆæ¯æ¬¡æ‰“å¼€ WSL è‡ªåŠ¨ç”¨å®ƒï¼‰ï¼š

   ```bash
   nvm alias default v20.18.0
   ```

5. éªŒè¯ï¼š

   ```bash
   node -v
   npm -v
   ```

---

## å…­ã€WSL é‡Œå¸¸è§å‘é¡ºæ‰‹è¯´ä¸€ä¸‹

### 1. `nvm: command not found`

å…¸å‹åŸå› ï¼š

* ä½ æ˜¯åœ¨ **root ç”¨æˆ·** ä¸‹æ•²çš„å‘½ä»¤ï¼Œè€Œ nvm æ˜¯åœ¨æ™®é€šç”¨æˆ·ä¸‹è£…çš„ã€‚
* æˆ–è€…ç»ˆç«¯/è„šæœ¬å¯åŠ¨æ—¶æ²¡æœ‰åŠ è½½ `~/.bashrc`ã€‚

è§£å†³æ–¹æ¡ˆï¼ˆä»»é€‰å…¶ä¸€ï¼‰ï¼š

* ä¿è¯ç”¨ä½ å¹³æ—¶çš„æ™®é€šç”¨æˆ·ï¼ˆæ¯”å¦‚ `bill`ï¼‰è¿›å…¥ WSLï¼Œå†æ‰§è¡Œ `source ~/.bashrc` ç„¶å `nvm --version`ã€‚
* æˆ–è€…åœ¨è„šæœ¬ä¸€å¼€å¤´æ˜¾å¼åŠ è½½ï¼š

  ```bash
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
  ```

---

### 2. Node ç”¨åˆ°äº† Windows é‡Œçš„ç‰ˆæœ¬

ä½ ä»¥å‰åœ¨ Windows ä¸Šè£…è¿‡ Nodeï¼ˆexe å®‰è£…ç‰ˆï¼‰ï¼Œåœ¨ WSL ä¸­å¯èƒ½ä¼šä¸å°å¿ƒç”¨åˆ° `/mnt/c/Program Files/nodejs/node.exe`ã€‚

åœ¨ WSL é‡Œæ£€æŸ¥ï¼š

```bash
which node
```

* å¦‚æœè¾“å‡ºç±»ä¼¼ `/home/bill/.nvm/.../bin/node` å°±æ­£å¸¸ã€‚
* å¦‚æœæ˜¯ `/mnt/c/...`ï¼Œè¯´æ˜èµ°çš„æ˜¯ Windows çš„ Nodeï¼Œå»ºè®®ï¼š

  * è¦ä¹ˆå¸è½½ Windows çš„ Nodeï¼›
  * è¦ä¹ˆåœ¨ `~/.bashrc` å‰é¢ `export PATH` æ—¶ï¼ŒæŠŠ nvm çš„è·¯å¾„æ”¾åœ¨æœ€å‰é¢ï¼Œæˆ–æ˜¾å¼æ¸…ç†æ‰ Windows PATH æ³¨å…¥çš„é‚£ä¸€æ®µã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥æŠŠä½ ç°åœ¨çš„ WSL æç¤ºç¬¦ã€shell ç±»å‹ï¼ˆbash/zshï¼‰å‘ç»™æˆ‘ï¼Œæˆ‘å¯ä»¥å¸®ä½ æŒ‰ä½ çš„ç¯å¢ƒå†™ä¸€ä»½**å®Œæ•´å¯å¤åˆ¶ç²˜è´´çš„åˆå§‹åŒ–è„šæœ¬**ï¼Œé¡ºä¾¿æŠŠ `nvm use` é‚£ç±»å‘½ä»¤ä¸€èµ·é…å¥½ã€‚


#  é…ç½® apt

å¥½ï¼Œæœ‰äº†è¿™ä¸¤æ®µ `env | grep -i proxy`ï¼Œç°åœ¨è„‰ç»œéå¸¸æ¸…æ¥šäº†ï¼š

* **18.04** é‡Œï¼šç¯å¢ƒå˜é‡é‡Œä»£ç†é…å¾—å¾ˆå…¨ï¼ˆHTTP/HTTPS/FTP/ALL_PROXY éƒ½æ˜¯ `http://127.0.0.1:7890`ï¼‰âœ…
* **24.04** é‡Œï¼šä¹Ÿæœ‰ HTTP_PROXY/HTTPS_PROXY æŒ‡å‘ `127.0.0.1:7890`âœ…

ä½†æ˜¯ï¼š

* **apt è¿˜æ˜¯åœ¨æŠ¥ `Temporary failure resolving 'archive.ubuntu.com'`** âŒ
* è¯´æ˜ï¼š**apt æ ¹æœ¬æ²¡ç”¨ä½ çš„è¿™äº› proxy ç¯å¢ƒå˜é‡ï¼Œä»ç„¶åœ¨è‡ªå·±ç›´æ¥è§£æ archive.ubuntu.comï¼Œç»“æœè¢« 198.18.0.2 è¿™å¥— DNS ç¯å¢ƒå‘äº†**

Ubuntu/Debian ä¸Š apt é»˜è®¤æ˜¯**ä¸ä¼šä¿¡ä»»ç¯å¢ƒå˜é‡é‡Œçš„ proxy**ï¼ˆå®‰å…¨åŸå› ï¼‰ï¼Œè¦åœ¨é…ç½®æ–‡ä»¶é‡Œæ˜¾å¼å†™ã€‚
æ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¦åšçš„ï¼Œå°±æ˜¯ï¼š

> ğŸ‘‰ åœ¨ 18.04 å’Œ 24.04 é‡Œé¢éƒ½ç»™ apt å†™ä¸€ä»½ â€œå›ºå®šèµ° `127.0.0.1:7890` ä»£ç†â€ çš„é…ç½®ï¼Œè¿™æ · apt ä¸éœ€è¦è‡ªå·±è§£æ `archive.ubuntu.com`ï¼Œåªéœ€è¦è¿æœ¬æœºä»£ç†å°±è¡Œã€‚

---

## ä¸€ã€åœ¨ 18.04 é‡Œç»™ apt é…ä»£ç†

åœ¨ **Ubuntu 18.04ï¼ˆbionicï¼‰** é‚£ä¸ª WSL ç»ˆç«¯é‡Œæ‰§è¡Œï¼š

```bash
# ç¡®è®¤ä¸€ä¸‹çœŸçš„æ˜¯ bionicï¼ˆä½ ä¹‹å‰å·²ç»ç¡®è®¤è¿‡ï¼Œè¿™é‡Œåªæ˜¯é˜²æ­¢è·‘é”™ç»ˆç«¯ï¼‰
. /etc/os-release 2>/dev/null; echo "ID=$ID CODENAME=${VERSION_CODENAME:-?} VERSION=$VERSION"

# å†™ apt ä»£ç†é…ç½®
sudo tee /etc/apt/apt.conf.d/99proxy >/dev/null <<'EOF'
Acquire::http::Proxy  "http://127.0.0.1:7890/";
Acquire::https::Proxy "http://127.0.0.1:7890/";
Acquire::ftp::Proxy   "http://127.0.0.1:7890/";
EOF
```

ç„¶åç›´æ¥æµ‹è¯•ï¼š

```bash
sudo apt update
```

**å¦‚æœä¸€åˆ‡æ­£å¸¸**ï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š

```text
Get:1 http://archive.ubuntu.com/ubuntu bionic InRelease [xxx kB]
Get:2 http://security.ubuntu.com/ubuntu bionic-security InRelease [xxx kB]
...
```

è€Œä¸ä¼šå†æ˜¯ `Temporary failure resolving 'archive.ubuntu.com'` è¿™ç§ DNS æŠ¥é”™ã€‚

> åŸç†ï¼š
> apt ç°åœ¨ä¸å†å»è§£æ `archive.ubuntu.com` çš„ IPï¼Œè€Œæ˜¯ç›´æ¥è¿åˆ° **127.0.0.1:7890**ã€‚
> åœ¨ HTTP è¯·æ±‚é‡ŒæŠŠ `Host: archive.ubuntu.com` äº¤ç»™ä½ çš„ä»£ç†ï¼ˆClash/å…¶å®ƒï¼‰å»è§£æï¼Œæ‰€ä»¥ DNS äº¤ç»™ä»£ç†å¤„ç†ï¼Œç»•å¼€äº†ç³»ç»Ÿçš„çƒ‚ DNSã€‚

---

## äºŒã€åœ¨ 24.04 é‡ŒåŒæ ·ç»™ apt é…ä»£ç†

åœ¨ **Ubuntu 24.04ï¼ˆnobleï¼‰** é‚£ä¸ª WSL ç»ˆç«¯é‡Œï¼ˆä½ ä¹‹å‰æ˜¯ root æç¤ºç¬¦ï¼‰æ‰§è¡Œï¼š

```bash
. /etc/os-release 2>/dev/null; echo "ID=$ID CODENAME=${VERSION_CODENAME:-?} VERSION=$VERSION"
# ç¡®è®¤æ˜¯ CODENAME=noble

sudo tee /etc/apt/apt.conf.d/99proxy >/dev/null <<'EOF'
Acquire::http::Proxy  "http://127.0.0.1:7890/";
Acquire::https::Proxy "http://127.0.0.1:7890/";
Acquire::ftp::Proxy   "http://127.0.0.1:7890/";
EOF
```

ç„¶åï¼š

```bash
sudo apt update
```

æ­£å¸¸çš„è¯ï¼Œè¿™é‡Œä¹Ÿä¼šå¼€å§‹ä» `archive.ubuntu.com`ã€`security.ubuntu.com` æ‹‰ä¸œè¥¿ï¼Œè€Œä¸å†æŠ¥ä¸´æ—¶è§£æå¤±è´¥ã€‚

---

## ä¸‰ã€é¡ºæ‰‹å¸®ä½ ç¡®è®¤ä»£ç†é€šä¸é€šï¼ˆå¯é€‰ä½†æ¨èï¼‰

ä¸ºäº†é¿å… 127.0.0.1:7890 æœ¬èº«æ²¡æœ‰ç›‘å¬æˆ–æŒ‚äº†ï¼Œå¯ä»¥åœ¨å…¶ä¸­ä¸€ä¸ª WSL é‡Œï¼ˆæ¯”å¦‚ 18.04ï¼‰æµ‹è¯•ä¸€ä¸‹ï¼š

```bash
curl -x http://127.0.0.1:7890 -I http://archive.ubuntu.com/ubuntu/
```

å¦‚æœèƒ½çœ‹åˆ° 301/200 ä¸€ç±»çš„ HTTP å“åº”å¤´ï¼Œå°±è¯´æ˜ï¼š

* WSL èƒ½è¿åˆ°ä½  Windows ä¸Šçš„ä»£ç†ç«¯å£
* ä»£ç†èƒ½å¸®ä½ è®¿é—® `archive.ubuntu.com`ï¼Œapt èµ°å®ƒæ˜¯æ²¡é—®é¢˜çš„

---

## å››ã€ä½ ç°åœ¨å¯ä»¥æœŸå¾…çš„æ•ˆæœ

åšå®Œä¸Šé¢ä¸¤æ­¥ä¹‹åï¼š

* **18.04**ï¼š

  * `sudo apt update` æ­£å¸¸
  * `sudo apt install dos2unix` ä¹Ÿå°±å¯ä»¥è·‘äº†ï¼ˆä¸è¿‡ä½ å·²ç»æœ‰ `sed` æ–¹æ¡ˆäº†ï¼‰

* **24.04**ï¼š

  * `sudo apt update` æ­£å¸¸
  * ä»¥åè¦è£…ä¸œè¥¿ï¼ˆæ¯”å¦‚è¡¥ä¸€äº›ä¾èµ–ï¼‰ä¹Ÿä¸ä¼šå†è¢« â€œTemporary failure resolving â€¦â€ å¡æ­»

åŒæ—¶ï¼š

* ä½ ä¹‹å‰ç”¨çš„ `curl`ã€`nvm å®‰è£…è„šæœ¬` è¿™æ¡è·¯çº¿ç»§ç»­ç”¨ç¯å¢ƒå˜é‡é‡Œçš„ä»£ç†ï¼Œæ²¡é—®é¢˜ï¼›
* apt åˆ™é€šè¿‡ `/etc/apt/apt.conf.d/99proxy` åŒæ­¥ç”¨ä¸Šè¿™æ¡ä»£ç†é€šè·¯ï¼Œå½»åº•æ‘†è„±ç³»ç»Ÿ DNS è¿™å¨å‘ã€‚

---

ä½ ç°åœ¨å¯ä»¥å…ˆåœ¨ **18.04** é‡Œè·‘ä¸€é `99proxy` é‚£å‡ è¡Œï¼Œå† `sudo apt update` æŠŠå®Œæ•´è¾“å‡ºè´´å‡ºæ¥ï¼ˆå¦‚æœè¿˜æŠ¥é”™çš„è¯ï¼‰ï¼›
å†åœ¨ **24.04** é‡Œåšä¸€éï¼Œapt ä¸€æ—¦æ¢å¤æ­£å¸¸ï¼Œæˆ‘ä»¬åé¢åœ¨è¿™ä¸¤ä¸ªç¯å¢ƒé‡Œè£…ä¸œè¥¿å°±éƒ½ä¸ä¼šå†è¢« DNS æŠ˜ç£¨äº†ã€‚





















## ä½ è¿™ä»½é…ç½®é‡Œéœ€è¦æ³¨æ„çš„å‡ ç‚¹

1. **é‡å¤/è¦†ç›–**
   ä½ å…ˆå†™äº†å›ºå®š IPï¼š

```bash
export http_proxy="http://192.168.110.67:7890"
export https_proxy="http://192.168.110.67:7890"
```

åé¢åˆç”¨é»˜è®¤ç½‘å…³ `GW=` è¦†ç›–äº†åŒåå˜é‡ã€‚æœ€ç»ˆç”Ÿæ•ˆçš„æ˜¯**åè€…**ã€‚å»ºè®®ä¿ç•™ä¸€ç§æ¥æºï¼Œå¹¶è®¾ç½®**å›é€€**ã€‚

2. **`ftp_proxy` æŒ‡å‘ 127.0.0.1**
   WSL2 å†…éƒ¨çš„ `127.0.0.1` æ˜¯ **WSL è‡ªå·±**ï¼Œä¸æ˜¯ Windowsã€‚é™¤éä½ çš„ä»£ç†å·¥å…·çœŸçš„åœ¨ WSL é‡Œè·‘ï¼Œå¦åˆ™ä¼šè¿ä¸ä¸Šã€‚å»ºè®®ä¸ `GW` ä¿æŒä¸€è‡´ã€‚

3. **`ALL_PROXY`/å¤§å°å†™**
   å¾ˆå¤šå·¥å…·è¯†åˆ« `ALL_PROXY`ï¼Œæœ‰äº›è¯†åˆ«å¤§å†™ï¼Œæœ‰äº›è¯†åˆ«å°å†™ï¼ˆcurl ä¸¤è€…éƒ½è®¤ï¼‰ã€‚å»ºè®®**å¤§å°å†™éƒ½å¯¼å‡º**ï¼Œæå‡å…¼å®¹æ€§ã€‚

4. **`no_proxy`**
   å»ºè®®æŠŠ **WSL å¸¸è§ç½‘æ®µ**ã€`.wsl`ã€`host.docker.internal` ä¹ŸåŠ ä¸Šï¼Œå‡å°‘ç¯å›ä»£ç†å¯¼è‡´çš„å¥‡æ€ªé—®é¢˜ã€‚

---

## æ¨èçš„ç¨³å¥ç‰ˆ `~/.bashrc`ï¼ˆUbuntu 18.04/24.04/WSL2 é€šç”¨ï¼‰
```
vim ~/.bashrc
source ~/.bashrc
```

```bash
# ---------- WSL2 auto-proxy (robust) ----------
# 1) å–é»˜è®¤ç½‘å…³ï¼ˆWSL2 -> Windows å®¿ä¸»ï¼‰
GW="$(ip route 2>/dev/null | awk '/default/ {print $3; exit}')"

# 2) ä»£ç†ç«¯å£ï¼ˆæŒ‰ä½ çš„å·¥å…·æ”¹ï¼‰
PROXY_PORT=7890

# 3) å¦‚æœ GW å­˜åœ¨ï¼Œå°±ç”¨ GWï¼›å¦åˆ™å¯å›é€€åˆ°é™æ€ IPï¼ˆå¯é€‰ï¼‰
#    å¦‚æœä½ å·²çŸ¥å®¿ä¸»å›ºå®š IPï¼Œå¯æŠŠ FALLBACK_HOST æ”¹æˆ 192.168.x.x
FALLBACK_HOST=""  # ä¾‹å¦‚ï¼šFALLBACK_HOST="192.168.110.67"

HOST_FOR_PROXY="$GW"
if [ -z "$HOST_FOR_PROXY" ] && [ -n "$FALLBACK_HOST" ]; then
  HOST_FOR_PROXY="$FALLBACK_HOST"
fi

# 4) å¼€å…³å‡½æ•°ï¼ˆéœ€è¦æ—¶ä¸€é”® on/offï¼‰
proxy_on() {
  if [ -n "$HOST_FOR_PROXY" ]; then
    export http_proxy="http://${HOST_FOR_PROXY}:${PROXY_PORT}"
    export https_proxy="$http_proxy"
    export ftp_proxy="$http_proxy"
    export all_proxy="$http_proxy"
    export HTTP_PROXY="$http_proxy"
    export HTTPS_PROXY="$http_proxy"
    export FTP_PROXY="$http_proxy"
    export ALL_PROXY="$http_proxy"
    # no_proxyï¼šæœ¬æœº/å†…ç½‘/WSLå¸¸è§åŸŸ
    export no_proxy="localhost,127.0.0.1,::1,.local,.wsl,host.docker.internal,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
    export NO_PROXY="$no_proxy"
  else
    echo "[proxy_on] æœªæ‰¾åˆ°å®¿ä¸»æœºç½‘å…³ä¸”æœªé…ç½® FALLBACK_HOSTï¼Œæœªè®¾ç½®ä»£ç†å˜é‡ã€‚" >&2
  fi
}

proxy_off() {
  unset http_proxy https_proxy ftp_proxy all_proxy HTTP_PROXY HTTPS_PROXY FTP_PROXY ALL_PROXY
  unset no_proxy NO_PROXY
  echo "[proxy_off] å·²æ¸…é™¤ä»£ç†ç¯å¢ƒå˜é‡ã€‚"
}

# é»˜è®¤è‡ªåŠ¨å¼€ï¼ˆå¦‚ä¸æƒ³é»˜è®¤å¼€ï¼Œå¯æ³¨é‡Šä¸‹ä¸€è¡Œï¼‰
proxy_on

# ---------- ä½ çš„äº¤å‰ç¼–è¯‘å™¨PATH ----------
export PATH="$PATH:/mnt/d/_gk72010300/sdk/tools/toolchains/arm-gcc7.3-linux-musleabi/bin"
```

> å°è´´å£«ï¼šå¦‚æœä½ çš„ä»£ç†å·¥å…·æ”¯æŒ `socks5h`ï¼Œä¹Ÿå¯ä»¥æŠŠ `ALL_PROXY` æ”¹æˆ `socks5h://$HOST:$PORT`ï¼ˆåŸŸåè§£æèµ°ä»£ç†ï¼Œæ›´ç¨³ï¼‰ã€‚

---

## éªŒè¯æ˜¯å¦ç”Ÿæ•ˆ

1. **çœ‹å˜é‡**

```bash
echo $http_proxy
echo $no_proxy
```

2. **è¿é€šæ€§ï¼ˆåŸŸåè§£æ + HTTP è¯·æ±‚ï¼‰**

```bash
curl -I http://www.baidu.com
curl -I https://www.google.com    # å¦‚éœ€èµ°ä»£ç†åœºæ™¯
```

3. **æ£€æŸ¥å½“å‰é»˜è®¤ç½‘å…³**

```bash
ip route | sed -n '1,2p'
```

å¦‚ `curl` èƒ½è¿”å› 200/302 ç­‰å“åº”å¤´ï¼Œç½‘ç»œå°±é€šäº†ã€‚

---

## apt / git / npm ç­‰å·¥å…·çš„ä»£ç†

* **apt**ï¼ˆéœ€è¦ç³»ç»Ÿçº§èµ°ä»£ç†æ—¶ï¼Œæ‰é…ç½®ï¼›å¦åˆ™ç»§æ‰¿ç¯å¢ƒå˜é‡å³å¯ï¼‰ï¼š

  ```bash
  sudo mkdir -p /etc/apt/apt.conf.d
  printf 'Acquire::http::Proxy "%s";\nAcquire::https::Proxy "%s";\n' \
    "$http_proxy" "$https_proxy" | sudo tee /etc/apt/apt.conf.d/99proxy
  ```

  å–æ¶ˆæ—¶ï¼š`sudo rm /etc/apt/apt.conf.d/99proxy`

* **git**ï¼š

  ```bash
  git config --global http.proxy  "$http_proxy"
  git config --global https.proxy "$https_proxy"
  # å–æ¶ˆï¼šgit config --global --unset http.proxy
  ```

* **npm**ï¼š

  ```bash
  npm config set proxy  "$http_proxy"
  npm config set https-proxy "$https_proxy"
  # å–æ¶ˆï¼šnpm config delete proxy ; npm config delete https-proxy
  ```

---

## Ubuntu 24.04 åœ¨ WSL2 çš„å·®å¼‚ç‚¹ï¼ˆä½ å¯èƒ½ä¼šé‡åˆ°ï¼‰

* **systemd é»˜è®¤å¯ç”¨**ï¼š24.04 åœ¨ WSL2 ä¸­å¤šä¸ºå¼€å¯ systemdï¼ŒæœåŠ¡ç®¡ç†ï¼ˆå¦‚ `systemctl`ï¼‰å¯ç”¨ï¼›è¿™ä¸å½±å“ä»£ç†å˜é‡ç”¨æ³•ã€‚
* **`/etc/resolv.conf`** ç”± WSL ç®¡ç†ï¼Œå¦‚æœä½ æ›¾æ‰‹æ”¹ DNSï¼Œå»ºè®®æ¢å¤é»˜è®¤ï¼ˆæˆ–åœ¨ Windows ç«¯ä¿®å¤ç½‘ç»œå `wsl --shutdown` å†é‡è¿›ï¼‰ã€‚
* **`host.docker.internal` å¯ç”¨**ï¼šåœ¨ WSL2 æ–°ç‰ˆé‡ŒåŸºæœ¬å¯è§£æä¸ºå®¿ä¸»æœºï¼Œä½œä¸ºä»£ç†ä¸»æœºåä¹Ÿå¯ä¸€è¯•ï¼š

  ```bash
  export http_proxy="http://host.docker.internal:7890"
  ```

---

## å¸¸è§æ•…éšœæ’æŸ¥

* ä»£ç†å¼€äº†ä½†è¿˜æ˜¯ä¸é€šï¼š

  * ä½ çš„ä»£ç†å·¥å…·æ˜¯å¦çœŸçš„ç›‘å¬åœ¨ **å®¿ä¸»æœºç½‘å¡**ï¼ˆ0.0.0.0ï¼‰è€Œä¸æ˜¯ä»… 127.0.0.1ï¼Ÿ
  * ç«¯å£å¯¹å—ï¼Ÿï¼ˆ7890/1080 ç­‰ï¼‰
  * Windows é˜²ç«å¢™æ˜¯å¦å…è®¸è¯¥ç¨‹åºå¯¹å±€åŸŸç½‘ç›‘å¬ï¼Ÿ
  * åœ¨ WSL é‡Œ `curl http://$GW:7890` çœ‹çœ‹æœ‰æ— å“åº”ï¼ˆå¦‚è¿”å›é”™è¯¯ä¹Ÿä»£è¡¨ç«¯å£å¯è¾¾ï¼‰ã€‚

* åªæœ‰ `ping` åŸŸåå¤±è´¥ï¼š

  * `ping` ç”¨ ICMPï¼Œä¸ HTTP ä»£ç†æ— å…³ï¼Œ**ç”¨ `curl` éªŒè¯**æ›´å‡†ç¡®ã€‚
  * DNS é—®é¢˜æ—¶å¯è¯•ä¸´æ—¶æŒ‡å®šï¼š

    ```bash
    sudo bash -c 'echo "nameserver 8.8.8.8" > /etc/resolv.conf'
    # ä¹‹å wsl --shutdown å†è¿› å¯èƒ½ä¼šè¢«é‡ç½®ï¼›å¦‚è¦é•¿æœŸæ”¹ï¼Œç”¨ wsl.conf ç®¡ç†
    ```

---

### å°ç»“

2. nvm å®‰è£…ä¹Ÿä¸éœ€è¦ apt

ä½ æœ‰ curlï¼Œå¤–ç½‘é€šï¼Œé‚£ç›´æ¥ç”¨å®˜æ–¹è„šæœ¬å°±è¡Œï¼ˆå»ºè®®åœ¨ 24.04 é‚£ä¸ªç¯å¢ƒ é‡Œè£… nvmï¼‰ï¼š

# åœ¨ 24.04 é‡Œï¼Œä»¥æ™®é€šç”¨æˆ· bill æ‰§è¡Œï¼Œä¸è¦ç”¨ sudo
curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

# è®©å½“å‰ shell ç”Ÿæ•ˆ
source ~/.bashrc

# çœ‹ç‰ˆæœ¬
nvm --version

# å®‰è£…ä¸€ä¸ª LTS ç‰ˆæœ¬ Node
nvm install --lts
nvm alias default 'lts/*'
node -v
npm -v